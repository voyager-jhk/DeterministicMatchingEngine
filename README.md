# ğŸš€ Deterministic Matching Engine

**Jane Street é‡åŒ–äº¤æ˜“å®ä¹ é¡¹ç›® - ç”Ÿäº§çº§è®¢å•æ’®åˆå¼•æ“**

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
MatchingEngine/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types.hpp          # å¼ºç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ order.hpp          # Order, LimitLevel
â”‚   â”œâ”€â”€ events.hpp         # äº‹ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ orderbook.hpp      # æ ¸å¿ƒæ’®åˆé€»è¾‘
â”‚   â”œâ”€â”€ replay.hpp         # é‡æ”¾å¼•æ“
â”‚   â””â”€â”€ main.cpp           # æ¼”ç¤ºç¨‹åº
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit_tests.cpp     # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ property_tests.cpp # æ€§è´¨æµ‹è¯•
â”œâ”€â”€ benchmarks/
â”‚   â””â”€â”€ perf.cpp           # æ€§èƒ½æµ‹è¯•
â”œâ”€â”€ CMakeLists.txt         # æ„å»ºé…ç½®
â””â”€â”€ README.md              # æœ¬æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### **1. ç¼–è¯‘é¡¹ç›®**

```bash
# åˆ›å»ºæ„å»ºç›®å½•
mkdir build && cd build

# é…ç½® (Release æ¨¡å¼)
cmake -DCMAKE_BUILD_TYPE=Release ..

# ç¼–è¯‘ (ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ)
make -j$(nproc)

# æˆ–è€… Windows:
# cmake -G "Visual Studio 17 2022" ..
# cmake --build . --config Release
```

### **2. è¿è¡Œæ¼”ç¤º**

```bash
# ä¸»æ¼”ç¤ºç¨‹åº
./matching_engine_demo

# å•å…ƒæµ‹è¯•
./matching_engine_unit_tests

# æ€§è´¨æµ‹è¯• (QuickCheck é£æ ¼)
./matching_engine_property_tests

# æ€§èƒ½åŸºå‡†æµ‹è¯•
./matching_engine_benchmarks
```

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### **1. ç¼–è¯‘æœŸç±»å‹å®‰å…¨**

```cpp
using Price = StrongType<double, PriceTag>;
using Quantity = StrongType<uint64_t, QuantityTag>;
// ç¼–è¯‘å™¨é˜²æ­¢å‚æ•°æ··æ·†
```

### **2. äº‹ä»¶æº¯æºæ¶æ„**

```cpp
// æ‰€æœ‰çŠ¶æ€å˜åŒ–éƒ½é€šè¿‡äº‹ä»¶è®°å½•
OrderBook book;
book.process_new_order(...);
// è‡ªåŠ¨ç”Ÿæˆ NewOrderEvent å’Œ TradeEvent
```

### **3. å½¢å¼åŒ–ä¸å˜é‡**

```cpp
// 6 ä¸ªå…³é”®ä¸å˜é‡åœ¨æ¯æ¬¡æ“ä½œåéªŒè¯
assert(book.check_invariants());
// 1. best_bid < best_ask
// 2. total_volume = Î£ remaining_qty
// 3. remaining_qty â‰¤ original_qty
// ... (è¯¦è§ä»£ç )
```

### **4. å®Œæ•´é‡æ”¾èƒ½åŠ›**

```cpp
// ä»äº‹ä»¶æ—¥å¿—ç²¾ç¡®é‡å»ºçŠ¶æ€
OrderBook replayed = ReplayEngine::replay_from_log(events);
```

### **5. Property-Based Testing**

```cpp
// éšæœºæµ‹è¯• 1000 æ¬¡ï¼ŒéªŒè¯æ‰€æœ‰ä¸å˜é‡
for 1000 trials:
    ç”Ÿæˆéšæœºè®¢å•åºåˆ—
    éªŒè¯è®¢å•ç°¿æ°¸ä¸äº¤å‰
    éªŒè¯é‡æ”¾äº§ç”Ÿç›¸åŒç»“æœ
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### **ç±»å‹å±‚æ¬¡**

```
StrongType<T, Tag>           # ç¼–è¯‘æœŸç±»å‹å®‰å…¨
    â”œâ”€â”€ OrderId
    â”œâ”€â”€ Price
    â”œâ”€â”€ Quantity
    â””â”€â”€ Timestamp

Order                        # ä¸å¯å˜è®¢å•
    â”œâ”€â”€ id
    â”œâ”€â”€ timestamp
    â”œâ”€â”€ side (BUY/SELL)
    â”œâ”€â”€ price
    â””â”€â”€ remaining_qty

LimitLevel                   # FIFO ä»·æ ¼çº§åˆ«
    â”œâ”€â”€ price
    â”œâ”€â”€ orders (queue)
    â””â”€â”€ total_volume

OrderBook                    # æ ¸å¿ƒæ’®åˆå¼•æ“
    â”œâ”€â”€ bids (map, é™åº)
    â”œâ”€â”€ asks (map, å‡åº)
    â”œâ”€â”€ order_map
    â””â”€â”€ event_log
```

### **äº‹ä»¶ç³»ç»Ÿ**

```
Event (æŠ½è±¡åŸºç±»)
    â”œâ”€â”€ NewOrderEvent        # ç”¨æˆ·è¾“å…¥
    â”œâ”€â”€ CancelOrderEvent     # ç”¨æˆ·è¾“å…¥
    â””â”€â”€ TradeEvent           # ç³»ç»Ÿç”Ÿæˆ
```

---

## ğŸ¯ è®¾è®¡å†³ç­–

### **Q: ä¸ºä»€ä¹ˆç”¨ `std::map` è€Œä¸æ˜¯ `std::unordered_map`?**

**A:** å› ä¸ºè®¿é—®æœ€ä¼˜ä»·æ ¼æ˜¯æœ€é¢‘ç¹çš„æ“ä½œ (90%)ï¼š

- `std::map`: best_bid() = O(1) [begin()]
- `std::unordered_map`: best_bid() = O(N) [éå†æ‰€æœ‰é”®]

### **Q: ä¸ºä»€ä¹ˆç”¨äº‹ä»¶æº¯æº?**

**A:** ä¸‰ä¸ªå…³é”®åŸå› ï¼š

1. **ç¡®å®šæ€§**: ç›¸åŒè¾“å…¥äº§ç”Ÿç›¸åŒè¾“å‡ºï¼Œä¾¿äºè°ƒè¯•
2. **å¯å®¡è®¡**: å®Œæ•´è®°å½•æ‰€æœ‰æ“ä½œï¼Œæ»¡è¶³ç›‘ç®¡è¦æ±‚
3. **å¯æµ‹è¯•**: å¯ä»¥é‡æ”¾ä»»æ„å†å²çŠ¶æ€

### **Q: å¦‚ä½•ä¿è¯ç›˜å£ä¸ä¼šäº¤å‰?**

**A:** é€šè¿‡åŒ¹é…é€»è¾‘çš„è®¾è®¡ï¼š

```cpp
if (buy_order.price >= best_ask) {
    // ç«‹å³åŒ¹é…ï¼Œæ¶ˆè€—å¯¹æ‰‹æ–¹ä»·æ ¼
    match_with_asks(buy_order);
}
// å¦‚æœæœ‰å‰©ä½™ä¸” buy_order.price < best_askï¼ŒåŠ å…¥ bids
// å› æ­¤æ°¸è¿œæ»¡è¶³ best_bid < best_ask
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### **å•å…ƒæµ‹è¯• (9 ä¸ªåœºæ™¯)**

1. âœ… Simple Fill - å®Œå…¨åŒ¹é…
2. âœ… Partial Fill - éƒ¨åˆ†æˆäº¤
3. âœ… Multi-Level Sweep - è·¨ä»·æ ¼æ‰«å•
4. âœ… Cancel Order - è®¢å•å–æ¶ˆ
5. âœ… Price-Time Priority - FIFO éªŒè¯
6. âœ… Invariants - ä¸å˜é‡æ£€æŸ¥
7. âœ… Replay Determinism - é‡æ”¾ä¸€è‡´æ€§
8. âœ… Empty Book - ç©ºè®¢å•ç°¿è¾¹ç•Œ
9. âœ… Crossed Prevention - é˜²äº¤å‰ç›˜å£

### **æ€§è´¨æµ‹è¯• (5 ä¸ªå±æ€§)**

1. ğŸ”¬ Book Never Crosses - 1000 æ¬¡éšæœºæµ‹è¯•
2. ğŸ”¬ Replay Idempotence - 100 æ¬¡é‡æ”¾éªŒè¯
3. ğŸ”¬ Volume Conservation - æˆäº¤é‡å®ˆæ’
4. ğŸ”¬ FIFO Order - ä¸¥æ ¼æ—¶é—´ä¼˜å…ˆ
5. ğŸ”¬ Price Reasonableness - ä»·å·®åˆç†æ€§

---

## âš¡ æ€§èƒ½æ•°æ®

### **åŸºå‡†æµ‹è¯•ç»“æœ** (å‚è€ƒå€¼ï¼Œå–å†³äºç¡¬ä»¶)

| æŒ‡æ ‡       | æ•°å€¼           |
| ---------- | -------------- |
| ååé‡     | ~1M orders/sec |
| P50 å»¶è¿Ÿ   | <1 Î¼s          |
| P99 å»¶è¿Ÿ   | <5 Î¼s          |
| P99.9 å»¶è¿Ÿ | <50 Î¼s         |

### **å‹åŠ›æµ‹è¯•**

- âœ… 100 ä¸‡è®¢å•å¤„ç†æ— é”™è¯¯
- âœ… æ‰€æœ‰ä¸å˜é‡å§‹ç»ˆæ»¡è¶³
- âœ… å†…å­˜ä½¿ç”¨çº¿æ€§å¢é•¿ O(N)

---

## ğŸ” æ ¸å¿ƒä¸å˜é‡

### **å…¨å±€ä¸å˜é‡**

1. **ç›˜å£ä¸äº¤å‰**: `best_bid < best_ask` (å½“åŒæ–¹éƒ½å­˜åœ¨)
2. **æ•°é‡å®ˆæ’**: `LimitLevel.total_volume = Î£ order.remaining_qty`
3. **è®¢å•ä¸€è‡´æ€§**: `remaining_qty â‰¤ original_qty`
4. **æ—¶é—´å•è°ƒæ€§**: `event[i].timestamp â‰¤ event[i+1].timestamp`

### **å±€éƒ¨ä¸å˜é‡**

5. **FIFO é¡ºåº**: æ¯ä¸ªä»·æ ¼çº§åˆ«å†…ä¸¥æ ¼æŒ‰æ—¶é—´æ’åº
6. **ä»·æ ¼å•è°ƒæ€§**: Bids é™åºï¼ŒAsks å‡åº

---

## ğŸ“š é¢è¯•å‡†å¤‡

### **ä½ åº”è¯¥èƒ½è®¨è®ºçš„é—®é¢˜**

1. **è®¾è®¡æƒè¡¡**: ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ç§æ•°æ®ç»“æ„ï¼Ÿ
2. **å¤æ‚åº¦åˆ†æ**: æ¯ä¸ªæ“ä½œçš„æ—¶é—´/ç©ºé—´å¤æ‚åº¦ï¼Ÿ
3. **æ‰©å±•æ€§**: å¦‚ä½•æ”¯æŒå¤šäº¤æ˜“å¯¹ï¼Ÿå¦‚ä½•åˆ†å¸ƒå¼éƒ¨ç½²ï¼Ÿ
4. **æç«¯æƒ…å†µ**: å¦‚ä½•å¤„ç†è®¢å•ç°¿ä¸ºç©ºï¼Ÿè‡ªæˆäº¤ï¼Ÿ
5. **ä¼˜åŒ–æ–¹å‘**: å¦‚ä½•ä» 1M ops/s ä¼˜åŒ–åˆ° 10M ops/sï¼Ÿ

### **å…³é”®æ•°å­— (è¦è®°ä½)**

- ååé‡: ~1M orders/sec
- å»¶è¿Ÿ: P99 < 5Î¼s
- ä¸å˜é‡æ•°é‡: 6 ä¸ª
- æµ‹è¯•åœºæ™¯: 9 ä¸ªå•å…ƒ + 5 ä¸ªæ€§è´¨
- ä»£ç æ¨¡å—: 5 ä¸ªå¤´æ–‡ä»¶ + 4 ä¸ªå¯æ‰§è¡Œæ–‡ä»¶

---

## ğŸ“ æ‰©å±•æ–¹å‘ (å¯é€‰å®ç°)

### **Level 1: åŸºç¡€æ‰©å±•**

- [ ] Stop-Loss è®¢å•
- [ ] Iceberg è®¢å• (éšè—æ•°é‡)
- [ ] Market è®¢å•ä¼˜åŒ–
- [ ] Modify è®¢å• (åŸåœ°ä¿®æ”¹)

### **Level 2: ç”Ÿäº§ç‰¹æ€§**

- [ ] FIX åè®®æ¥å£
- [ ] æŒä¹…åŒ– (RocksDB)
- [ ] å¿«ç…§ä¸æ¢å¤
- [ ] é£æ§æ£€æŸ¥ (credit check)

### **Level 3: åˆ†å¸ƒå¼ç³»ç»Ÿ**

- [ ] Raft å…±è¯†åè®®
- [ ] è·¨åœ°åŸŸå¤åˆ¶
- [ ] è´Ÿè½½å‡è¡¡
- [ ] ç°åº¦å‘å¸ƒ

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **é¢è¯•é—®ç­”**: `docs/interview_qa.md` - 12 ä¸ªæ·±åº¦é—®é¢˜
- **æ¶æ„è®¾è®¡**: è¯¦è§æœ¬ README
- **API æ–‡æ¡£**: ä»£ç ä¸­çš„æ³¨é‡Š

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

è¿™æ˜¯ä¸€ä¸ªæ•™è‚²é¡¹ç›®ï¼Œæ¬¢è¿ï¼š

- æŠ¥å‘Š bug
- æå‡ºæ”¹è¿›å»ºè®®
- æ·»åŠ æµ‹è¯•ç”¨ä¾‹
- æ€§èƒ½ä¼˜åŒ–

---

## ğŸ“ License

MIT License - ä»…ç”¨äºæ•™è‚²å’Œé¢è¯•ç›®çš„

---

## ğŸ™ è‡´è°¢

æœ¬é¡¹ç›®è®¾è®¡ç†å¿µå—åˆ°ä»¥ä¸‹å¯å‘ï¼š

- Jane Street çš„å·¥ç¨‹æ–‡åŒ–
- Martin Fowler çš„äº‹ä»¶æº¯æºæ¨¡å¼
- QuickCheck çš„æ€§è´¨æµ‹è¯•æ–¹æ³•

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ– Pull Requestã€‚

**ç¥ä½ é¢è¯•æˆåŠŸï¼ğŸ€**

---

## ğŸ’¡ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# ä¸€é”®ç¼–è¯‘å’Œè¿è¡Œæ‰€æœ‰æµ‹è¯•
mkdir build && cd build && cmake .. && make -j$(nproc) && \
./matching_engine_demo && \
./matching_engine_unit_tests && \
./matching_engine_property_tests && \
./matching_engine_benchmarks
```

---

**æœ€åæ›´æ–°**: 2025
**ç‰ˆæœ¬**: 1.0.0
**ä½œè€…**: Jane Street é¢è¯•å€™é€‰äºº
